<!DOCTYPE html>
<script src="https://cdn.jsdelivr.net/gh/kitao/pyxel/wasm/pyxel.js"></script>


<script>
    // get username from localstorage
    const API_URL = "https://ishinoame.onrender.com";
    const user = localStorage.getItem("username") || "Anonymous";
    pyxel.globals.username = user;
    let pyxelLeaderboardData = [];
    
    // saving in pyxel.globals
    
    function sendScore(username, score) {
        fetch(`${API_URL}/submit-score`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, score }),
        })
        .then((r) => r.json())
        .then((data) => console.log("Score envoyé:", data))
        .catch((e) => console.error("Erreur POST:", e));
    }

    async function fetchLeaderboard() {
        return fetch(`${API_URL}/top`)
        .then((r) => r.json())
        .then((data) => {
            pyxelLeaderboardData = data;
            console.log("Leaderboard reçu:", data);
        })
        .catch((e) => console.error("Erreur GET:", e));
    }
    const waitForPyxel = setInterval(() => {
    if (typeof pyxel !== "undefined" && typeof pyxel.register === "function") {
        clearInterval(waitForPyxel);

        fetchLeaderboard().then(() => {
        pyxel.register("get_leaderboard", () => pyxelLeaderboardData);
        pyxel.register("sendScore", (username, score) => {
            sendScore(username, score);
        });
        });
    }}, 100);

</script>

<pyxel-run root="pyxel-game/" name="main.py"></pyxel-run>